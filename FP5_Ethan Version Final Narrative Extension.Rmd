---
title: "FP4 Ethan.RMD"
output: html_document
date: "2024-11-14"
author: "Ethan Caldecott"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# *Focus*: My job is to look at frequency of use look as my quality of life outcome after treatment. How substance abuse treatment impacts FREQUENCY OF USE in publicly-funded healthcare facilities? (skip to Data for Final section)

# Libraries
```{r}
library(tidyr)
library(dplyr)
library(ggplot2)
library(haven)
library(scales)
library(ggalluvial)
library(stringr)
library(randomForest)
library(ggmosaic)
library(viridis)
library(tidymodels) 
library(ranger) 
library(vip)
library(maps)
```

# Load Data
## Link to Codebook: https://www.samhsa.gov/data/system/files/media-puf-file/TEDS-D-2021-DS0001-info-codebook.pdf
```{r}
load("C:/Users/ethan/OneDrive/Desktop/STAT 456/TEDS-D-2021 October 28/tedsd_puf_2021_r.rdata")
```

# Randomly Exploring the Data
```{r}
summary(tedsd_puf_2021_r)
```

# Intermediate Presentation FP4
```{r}
# Reshape data for comparison
tedsd_long <- tedsd_puf_2021_r %>%
  select(FREQ1, FREQ1_D, FREQ2, FREQ2_D, FREQ3, FREQ3_D) %>%
  mutate(across(everything(), haven::as_factor))

# Plot stacked bar chart
ggplot(tedsd_long, aes(x = FREQ1, fill = FREQ1_D)) +
  geom_bar(position = "fill") +
  labs(title = "Frequency of Use at Admission vs. Discharge",
       y = "Proportion", x = "Admission",
       fill = "Frequency Level at Discharge") +
  theme_minimal() 

# Plot stacked bar chart
ggplot(tedsd_long, aes(x = FREQ2, fill = FREQ2_D)) +
  geom_bar(position = "fill") +
  labs(title = "Frequency of Use at Admission vs. Discharge",
       y = "Proportion", x = "Admission",
       fill = "Frequency Level at Discharge") +
  theme_minimal() 

# Plot stacked bar chart
ggplot(tedsd_long, aes(x = FREQ3, fill = FREQ3_D)) +
  geom_bar(position = "fill") +
  labs(title = "Frequency of Use at Admission vs. Discharge",
       y = "Proportion", x = "Admission",
       fill = "Frequency Level at Discharge") +
  theme_minimal() 
```
## Data Filters
```{r}
freq1_data <- tedsd_puf_2021_r %>%
  select(FREQ1, FREQ1_D, SUB1, SERVICES_D, LOS, REASON) %>%
  mutate(across(everything(), as.factor)) %>%
  rename(Freq = FREQ1, Freq_d = FREQ1_D, Sub = SUB1, Service_D = SERVICES_D) %>%
  mutate(Freq_Type = "Primary") %>%
  filter(Service_D != "1" | Service_D != "2") %>% 
  filter(REASON == "1") %>% 
  filter(Freq != -9 & Freq_d != -9 & Sub != -9) %>%
  mutate(LOS = as.integer(LOS)) %>%
  mutate(
    Freq_Label = case_when(
      Freq %in% c("1") ~ "No use in the past month",
      Freq %in% c("2") ~ "Some use",
      Freq %in% c("3") ~ "Daily use"  
    ),
    Freq_d_Label = case_when(
      Freq_d %in% c("1") ~ "No use in the past month",
      Freq_d %in% c("2") ~ "Some use",
      Freq_d %in% c("3") ~ "Daily use"  
    ),
    Service_D_Label = case_when(
      Service_D %in% c("1") ~ "Detox, 24-hour, hospital inpatient",
      Service_D %in% c("2")  ~ "Detox, 24-hour, free-standing residential",
      Service_D %in% c("3")  ~ "Rehab/residential, hospital (non-detox)",
      Service_D %in% c("4")  ~ "Rehab/residential, short term (30 days or fewer)",
      Service_D %in% c("5")  ~ "Rehab/residential, long term (more than 30 days)",
      Service_D %in% c("6")  ~ "Ambulatory, intensive outpatient",
      Service_D %in% c("7")  ~ "Ambulatory, non-intensive outpatient",
      Service_D %in% c("8")  ~ "Ambulatory, detoxification",
      TRUE ~ "Other"),
    LOS_Label = case_when(
      LOS == 31 ~ "31 to 45 days",
      LOS == 32 ~ "46 to 60 days",
      LOS == 33 ~ "61 to 90 days",
      LOS == 34 ~ "91 to 120 days",
      LOS == 35 ~ "121 to 180 days",
      LOS == 36 ~ "181 to 365 days",
      LOS == 37 ~ "More than a year",
      TRUE ~ "Other"
    )) %>% # Sorts Labels for Graphs
  mutate(
    Freq_d_Label = factor(Freq_d_Label, levels = c("No use in the past month", "Some use", "Daily use")),
    Freq_Label = factor(Freq_Label, levels = c("No use in the past month", "Some use", "Daily use")))  %>%
  filter(LOS_Label != "Other")
  
```

## All Substance Data
```{r}
freq1_data_all <- freq1_data %>%
    mutate(Sub_Label = "All Substances")  
```

## Alcohol, Opioids, Stimulants (AOS) Data 
```{r}
freq1_data_top3 <- freq1_data %>%
  mutate(Sub_Label = case_when(
      Sub %in% c("2") ~ "Alcohol",
      Sub %in% c("5", "7") ~ "Opioids",
      Sub %in% c("3", "10", "12") ~ "Stimulants",
      TRUE ~ "Other")) %>% 
  filter(Sub_Label != "Other") 
```

## Combine All Substance & AOS Data
```{r}
freq1_data_allANDtop3 <- rbind(freq1_data_all, freq1_data_top3) %>%
  mutate(Sub_Label = factor(Sub_Label, levels = c("All Substances", "Alcohol", "Opioids", "Stimulants")))
```

## Graph 1: Change in Frequency of Use from Admission to Discharge
```{r}
# Data Code
graph1part1 <- freq1_data_allANDtop3 %>%
  group_by(Sub_Label, Freq_d_Label) %>%
  count(name = "Freq_d_Count") %>%         
  ungroup() %>%
  group_by(Sub_Label) %>%
  mutate(Total_Count = sum(Freq_d_Count)) %>%
  mutate(Percentage_d = Freq_d_Count/Total_Count*100)

graph1part2 <- freq1_data_allANDtop3 %>%
  group_by(Sub_Label, Freq_Label) %>% 
  count(name = "Freq_Count") %>% # Count each Frequency and Substance pairing
  ungroup() %>%
  group_by(Sub_Label) %>% # Group by Substance
  mutate(
    Total_Count = sum(Freq_Count), # Total count for each Substance
    Percentage = (Freq_Count / Total_Count) * 100 # % for each Frequency 
  )

percentage_diff <- graph1part2 %>%
  inner_join(graph1part1, by = c("Sub_Label", "Freq_Label" = "Freq_d_Label")) %>%
  mutate(
    Percent_dminusa = Percentage_d - Percentage
  ) %>%
  select(Sub_Label, Freq_Label, Percent_dminusa, Percentage_d, Percentage)

# Graph Code
ggplot(percentage_diff, aes(x = Freq_Label, y = Percent_dminusa)) +
  geom_col(aes(fill = Freq_Label)) + 
  labs(
    title = "Change in Frequency of Use from Admission to Discharge",
    subtitle = "The % of use at Discharge - % of use at Addmission",
    x = "",
    y = "Difference in Percentage (%)",
    fill = "Frequency Level"
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") + 
  geom_text(aes(label = paste0(round(Percent_dminusa), "%")),  position = position_stack(vjust = 0.5), size = 5) +
  scale_fill_manual(values = c("No use in the past month" = "green", "Some use" = "yellow", "Daily use" = "red")) +
  facet_wrap(~ Sub_Label,ncol = 1) +  
  theme_minimal() +
  coord_flip()+
  scale_y_continuous(labels = label_percent(scale = 1)) +
  theme(legend.position = "top",
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 16),
    plot.title = element_text(face = "bold", size = 24),     
    plot.subtitle = element_text(size = 18),
    strip.text = element_text(size = 16, face = "bold"))

```

## Graph 2: Comparison of Frequency Levels at Admission and Discharge
```{r}
# Data Code
stackedbar_data <- percentage_diff %>%
  gather(key = "Stage", value = "Percentage", Percentage, Percentage_d) %>%
  mutate(Stage = ifelse(Stage == "Percentage", "Admission", "Discharge"))

# Graph Code
ggplot(stackedbar_data, aes(x = Stage, y = Percentage, fill = Freq_Label)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(round(Percentage, 0), "%")), 
            position = position_stack(vjust = 0.5), size = 5, color = "black") +
  facet_wrap(~ Sub_Label) +
  labs(
    title = "Comparison of Frequency Levels at Admission and Discharge",
    y = "Percentage (%)",
    fill = "Frequency Level",
    x = " "
  ) +
  scale_fill_manual(values = c("No use in the past month" = "green", "Some use" = "yellow", "Daily use" = "red")) +
  theme_minimal() +
  theme(legend.position = "top",
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 16),
    plot.title = element_text(face = "bold", size = 24),     
    plot.subtitle = element_text(size = 18),
    strip.text = element_text(size = 16, face = "bold"),
    axis.text.x = element_text(size = 16, face = "bold"))

```

## Graph 3: *Ambulatory* Comparison of Frequency Levels at Admission and Discharge
```{r}
# Data Code
graph1part1 <- freq1_data_allANDtop3 %>% 
  filter(str_starts(Service_D_Label, "Ambulatory")) %>% # Ambulatory ONLY
  group_by(Sub_Label, Freq_d_Label) %>%
  count(name = "Freq_d_Count") %>%         
  ungroup() %>%
  group_by(Sub_Label) %>%
  mutate(Total_Count = sum(Freq_d_Count)) %>%
  mutate(Percentage_d = Freq_d_Count/Total_Count*100)

graph1part2 <- freq1_data_allANDtop3 %>%
  filter(str_starts(Service_D_Label, "Ambulatory")) %>%
  group_by(Sub_Label, Freq_Label) %>%                     
  count(name = "Freq_Count") %>%                    
  ungroup() %>%
  group_by(Sub_Label) %>%                          
  mutate(
    Total_Count = sum(Freq_Count),                  
    Percentage = (Freq_Count / Total_Count) * 100  
  )

percentage_diff <- graph1part2 %>%
  inner_join(graph1part1, by = c("Sub_Label", "Freq_Label" = "Freq_d_Label")) %>%
  mutate(
    Percent_dminusa = Percentage_d - Percentage
  ) %>%
  select(Sub_Label, Freq_Label, Percent_dminusa, Percentage_d, Percentage)

stackedbar_data <- percentage_diff %>%
  gather(key = "Stage", value = "Percentage", Percentage, Percentage_d) %>%
  mutate(Stage = ifelse(Stage == "Percentage", "Admission", "Discharge"))

# Graph Code
ggplot(stackedbar_data, aes(x = Stage, y = Percentage, fill = Freq_Label)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(round(Percentage, 0), "%")), 
            position = position_stack(vjust = 0.5), size = 5, color = "black") +
  facet_wrap(~ Sub_Label) +
  labs(
    title = "*Residential Rehab* Comparison of Frequency Levels at Admission and Discharge",
    y = "Percentage (%)",
    fill = "Frequency Level",
    x = " "
  ) +
  scale_fill_manual(values = c("No use in the past month" = "green", "Some use" = "yellow", "Daily use" = "red")) +
  theme_minimal() +
  theme(legend.position = "top",
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 16),
    plot.title = element_text(face = "bold", size = 20),     
    plot.subtitle = element_text(size = 18),
    strip.text = element_text(size = 16, face = "bold"),
    axis.text.x = element_text(size = 16, face = "bold"))
```
## Graph 4: *Residential Rehab* Comparison of Frequency Levels at Admission and Discharge
```{r}
# Data Code
graph1part1 <- freq1_data_allANDtop3 %>%
  filter(!str_starts(Service_D_Label, "Ambulatory")) %>% # Non-Ambulatory aka Residential Rehab ONLY
  group_by(Sub_Label, Freq_d_Label) %>%
  count(name = "Freq_d_Count") %>%         
  ungroup() %>%
  group_by(Sub_Label) %>%
  mutate(Total_Count = sum(Freq_d_Count)) %>%
  mutate(Percentage_d = Freq_d_Count/Total_Count*100)

graph1part2 <- freq1_data_allANDtop3 %>%
  filter(!str_starts(Service_D_Label, "Ambulatory")) %>%
  group_by(Sub_Label, Freq_Label) %>% 
  count(name = "Freq_Count") %>% 
  ungroup() %>%
  group_by(Sub_Label) %>% 
  mutate(
    Total_Count = sum(Freq_Count),                  
    Percentage = (Freq_Count / Total_Count) * 100   
  )

percentage_diff <- graph1part2 %>%
  inner_join(graph1part1, by = c("Sub_Label", "Freq_Label" = "Freq_d_Label")) %>%
  mutate(
    Percent_dminusa = Percentage_d - Percentage
  ) %>%
  select(Sub_Label, Freq_Label, Percent_dminusa, Percentage_d, Percentage)

stackedbar_data <- percentage_diff %>%
  gather(key = "Stage", value = "Percentage", Percentage, Percentage_d) %>%
  mutate(Stage = ifelse(Stage == "Percentage", "Admission", "Discharge"))

# Graph Code
ggplot(stackedbar_data, aes(x = Stage, y = Percentage, fill = Freq_Label)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(round(Percentage, 0), "%")), 
            position = position_stack(vjust = 0.5), size = 5, color = "black") +
  facet_wrap(~ Sub_Label) +
  labs(
    title = "*Residential Rehab* Comparison of Frequency Levels at Admission and Discharge",
    y = "Percentage (%)",
    fill = "Frequency Level",
    x = " "
  ) +
  scale_fill_manual(values = c("No use in the past month" = "green", "Some use" = "yellow", "Daily use" = "red")) +
  theme_minimal() +
  theme(legend.position = "top",
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 16),
    plot.title = element_text(face = "bold", size = 20),     
    plot.subtitle = element_text(size = 18),
    strip.text = element_text(size = 16, face = "bold"),
    axis.text.x = element_text(size = 16, face = "bold"))
```

# Data for Final
I will not comment on my FP4 visualization as these were covered in the Intermediate Presentation and other times during class. 

## Labels included (Dataset Name: Description)
```{r}
data1 <- tedsd_puf_2021_r %>% 
  select(-c(DISYR, CASEID, ALCFLG, COKEFLG, MARFLG, HERFLG, METHFLG, OPSYNFLG, PCPFLG, HALLFLG, MTHAMFLG, AMPHFLG, STIMFLG, BENZFLG, TRNQFLG, BARBFLG, SEDHPFLG, INHFLG, OTCFLG, OTHERFLG, ALCDRUG, DETNLF, DETNLF_D, PREG, PRIMINC, CBSA2020, DAYWAIT, DETCRIM, ROUTE2, FREQ2, FREQ2_D, FRSTUSE2, ROUTE3, FREQ3, FREQ3_D, FRSTUSE3, PRIMINC, PRIMPAY)) %>%
  filter(FREQ1_D != -9) %>%
  filter(FREQ1 != -9) %>%
  select(
    # Target variable (1)
    FREQ1_D,
    # Demographic Variables (7)
    AGE, GENDER, RACE, ETHNIC, EDUC, MARSTAT, VET,
    # Other Outcome Variabl+s (5)
    EMPLOY, EMPLOY_D, LIVARAG, LIVARAG_D, FREQ1,
    # Non-Treatment Variables (8)
    # ROUTE1, DUE TO REPETIVENES 
    FRSTUSE1, DSMCRIT, PSYPROB, PSOURCE, STFIPS, ARRESTS_D,
    HLTHINS, NOPRIOR, 
    # Treatment-Related Variables (7)
    SUB1, 
    SUB2, SUB3, # BINARY YES/NO FILTER 1 NO
    METHUSE, LOS, SERVICES, FREQ_ATND_SELF_HELP_D
    ) %>%
  mutate(across(everything(), haven::as_factor)) %>%
  mutate(across(where(is.character), as.factor)) %>%
  mutate(across(where(is.numeric), ~ replace_na(., 0)))
data1$FREQ1_D <- droplevels(data1$FREQ1_D)
data1[data1 == -9] <- NA
```

## Check stuff
```{r}
colnames(data1)
table(data1$FREQ1_D)
table(data1$FREQ1)

```
## Random Forest
Great because all our variables are categorical including our outcome!
```{r}
rf_spec <- rand_forest() %>%
  set_engine(engine = 'ranger') %>% 
  set_args(mtry = NULL, 
           trees = 500, 
           min_n = 2,
           probability = FALSE, 
           importance = 'impurity') %>% 
  set_mode('classification') 

data_rec <- recipe(FREQ1_D ~ ., data = data1) # predict employment at discharge

data_wf <- workflow() %>%
  add_model(rf_spec) %>%
  add_recipe(data_rec)

rf_fit <- fit(data_wf, data = data1)

rf_fit
```

### Random Forest Variable Importance
The most important predictor of frequency of use at discharge is frequency of use at admission (makes sense considering about 70% of patients the admission usage doesn't change compared to the discharge usage) followed by state, which reflects geographic differences. Among treatment-related variables, only length of stay and services at admission rank highly, making them key factors to examine when addressing the research question focused on treatment impacts. These results suggest that treatment duration and type of services are important to understanding and improving frequency of use.
```{r}
#Variable importance
rf_fit %>% 
    extract_fit_engine() %>% 
    vip(num_features = 6, mapping = aes(fill = .data[["Variable"]])) +
    scale_fill_manual(values = c("grey", "grey", "grey" ,"#A94064" ,"#A94064" ,"grey" )) +
    labs(title = "Top 6 Most Important Variables ",
         subtitle = "in Predicting Frequency of Use at Discharge") +
    theme_classic() +
    theme(legend.position = "none",
          plot.title = element_text(face = "bold", size = 11),
          axis.text.y = element_blank(),       # Remove y-axis text
          axis.ticks.y = element_blank(),      # Remove y-axis ticks
          axis.line.y = element_blank())+    # Remove y-axis line)+
    geom_text(aes(label = c("FREQUENCY OF USE AT ADMISSION",
                            "STATE",
                            "LENGTH OF STAY",
                            "SERVICES AT ADMISSION",
                            "AGE",
                            "AGE AT FIRST USE"), 
                            y = 0), hjust = 0, color = "black", size = 4, fontface = "bold")
```

### Accuracy Score of RF
The random forest model achieved an accuracy score of 83% when predicting the FREQ1_D (frequency of use at discharge) outcome. This means that the model correctly classified 83% of the cases in the out-of-bag (OOB) predictions. Even though the other outcomes had higher accuracy scores this is strong. Further analysis for the capstone presenation may go into precision, recall, and F1 scores to see what the model is doing good and bad at interms of accuracy. But the main point of the model was the variable importance scores for the sake of the presentation.
```{r}
#accuracy of random forest model
rf_OOB_output <- function(fit_model, model_label, truth){
    tibble(
          .pred_Unemployed = fit_model %>% extract_fit_engine() %>% pluck('predictions'), #OOB predictions
          FREQ1_D= truth,
          label = model_label
      )
}

output <- rf_OOB_output(rf_fit, "test", data1  %>% pull(FREQ1_D))

output %>% accuracy(truth = FREQ1_D, estimate = .pred_Unemployed) # print accuracy
```



##  Mosaic LOS
This visualization indicates that medium treatment durations (30–90 days) are associated with the best outcomes in terms of reduced frequency of substance use. However, nearly 50% of the dataset comprises patients with treatment durations of less than 30 days, which reflects more about the dataset's structure than the actual effectiveness of shorter treatments. Since the dataset is a random sample, relying on the proportion of cases in each category may lead to misleading conclusions and should be interpreted cautiously, focusing instead on relative trends within treatment durations.
```{r}
los_mosaic <- data1 %>%
  mutate(
    FREQ1 = as.numeric(factor(FREQ1, 
                              levels = c("No use in the past month", 
                                         "Some use", 
                                         "Daily use"))),
    FREQ1_D = as.numeric(factor(FREQ1_D, 
                                levels = c("No use in the past month", 
                                           "Some use", 
                                           "Daily use"))),
    EMPLOYMENT_CHANGE = case_when(
      FREQ1 == FREQ1_D ~ "Same",
      FREQ1 < FREQ1_D ~ "Worse",
      FREQ1 > FREQ1_D ~ "Improved"
    ),
    lengthOfStay = case_when(
      LOS %in% c("91 to 120 days", "121 to 180 days", "181 to 365 days", "More than a year") ~ "> 90 days",
      LOS %in% c("30", "31 to 45 days", "46 to 60 days", "61 to 90 days") ~ "30-90 days",
      TRUE ~ "< 30 days"  # Default case for all other values
    )
  )%>%
  mutate(lengthOfStay = factor(lengthOfStay, levels = c("< 30 days" , "30-90 days", "> 90 days"))) 


los_mosaic %>%
  ggplot() +
  geom_mosaic(aes(x = product(EMPLOYMENT_CHANGE, lengthOfStay), fill = EMPLOYMENT_CHANGE)) +
  geom_mosaic_text(aes(
    x = product(EMPLOYMENT_CHANGE, lengthOfStay), 
    label = paste0(round(after_stat(.wt) / sum(after_stat(.wt)) * 100, 1), "%")
  )) +
  labs(
    fill = "Usage Change",
    y = "Proportion of Substance Use Patients",
    x = "Length of Stay",
    title = "Impact of Length of Stay on Frequency of Use",
    subtitle = "Among Substance Use Patients in Public Facilities (2021)"
  ) +
  scale_fill_manual(
    values = c(
      "Improved" = "darkgreen",  # Green for improvement
      "Same" = "#D3D3D3",        # Gray for same
      "Worse" = "red"            # Red for worse
    )
  ) +
  theme_classic() +
  coord_flip() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    plot.subtitle = element_text(face = "italic", hjust = 0.5, size = 11)
  )
```

##  Mosaic Service
Similar to the previous mosaic, I see little need for the mosaic here as it takes away from the main point of who improved and who got worse. I like the green and red as it allows for easier interpretation, and the grey allows us to ignore the "same," which is not the main point of the visualization. This gives me the idea to explore a proportion plot, and I also like having the Service/Length of Stay on the y-axis versus having it as the legend.
```{r}
service_mosaic <- data1 %>%
  mutate(
    FREQ1 = as.numeric(factor(FREQ1, levels = c("No use in the past month", "Some use", "Daily use"))),
    FREQ1_D = as.numeric(factor(FREQ1_D, levels = c("No use in the past month", "Some use", "Daily use"))),
    EMPLOYMENT_CHANGE = case_when(FREQ1 == FREQ1_D ~ "Same", FREQ1 < FREQ1_D ~ "Worse", FREQ1 > FREQ1_D ~ "Improved"),
    lengthOfStay = case_when(SERVICES %in% c("Detox, 24-hour, hospital inpatient",
                                             "Detox, 24-hour, free-standing residential",
                                             "Ambulatory, detoxification") ~ "Detox",
                            SERVICES %in% c("Rehab/residential, hospital (non-detox)",
                                            "Rehab/residential, short term (30 days or fewer)",
                                            "Rehab/residential, long term (more than 30 days)") ~ "Rehab/Residential",
                            SERVICES %in% c("Ambulatory, intensive outpatient",
                                            "Ambulatory, non-intensive outpatient") ~ "Ambulatory"))
service_mosaic %>%
  ggplot() +
  geom_mosaic(aes(x = product(lengthOfStay, EMPLOYMENT_CHANGE), fill = lengthOfStay)) +
  geom_mosaic_text(aes(x = product(lengthOfStay, EMPLOYMENT_CHANGE), label = scales::percent(after_stat(.wt)/ sum(after_stat(.wt))))) +
   labs(fill = "Length of Treatment", y = "Proportion of Substance Use Patients", x = "Frequency of Use", title = "Impact of Service on Frequency of Use", subtitle = "Among Substance Use Patients in Public Facilities (2021)") +
  # scale_fill_manual(values = c("#2A788E", "#FDE725")) +
  scale_fill_viridis_d() +
  theme_classic() +
  coord_flip() +
  theme(legend.position = "bottom", axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
        plot.subtitle = element_text(face = "italic", hjust = 0.5, size = 11)) 

```

## Final 1: Proportions 3 Level LOS
This visualization demonstrates that medium treatment durations (30–90 days) are the most effective at reducing frequency of substance use, with 30.8% of patients improving compared to 27.7% for longer stays (>90 days) and 23.7% for shorter stays (<30 days). Medium stays allow sufficient time for patients to address both acute withdrawal symptoms and begin developing healthier habits and coping mechanisms. Longer stays show diminishing returns in frequency improvement, likely because stabilization is achieved earlier, and further progress depends more on external post-treatment factors. In contrast, short stays are insufficient to address the psychological complexities of recovery, highlighting the importance of having correct treatment duration.
```{r}
plot_data <- los_mosaic %>%
  count(lengthOfStay, EMPLOYMENT_CHANGE) %>%
  group_by(lengthOfStay) %>%
  mutate(proportion = n / sum(n)) %>%
  mutate(EMPLOYMENT_CHANGE = factor(EMPLOYMENT_CHANGE, levels = c("Worse", "Same", "Improved")))


ggplot(plot_data, aes(x = lengthOfStay, y = proportion, fill = EMPLOYMENT_CHANGE)) +
  geom_bar(stat = "identity", position = "fill") +
  geom_text(aes(label = scales::percent(proportion, accuracy = 0.1)), 
            position = position_fill(vjust = 0.5), size = 5, fontface = "bold") +
  labs(title = "Impact of Length of Stay on Frequency of Use", 
       subtitle = "Among Substance Use Patients in Public Facilities (2021)",
       x = "Length of Stay",
       y = "Percentage of Patients",
       fill = "Frequency of Use Change") +
  scale_fill_manual(values = c("Improved" = "darkgreen", "Same" = "gray", "Worse" = "red")) +
  theme_classic() +
  theme(legend.position = "bottom",
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
        plot.subtitle = element_text(face = "italic", hjust = 0.5, size = 11),
        axis.title.x = element_text(size = 14, face = "bold"), 
        axis.text.x = element_text(size = 12, face = "bold"))


```


## Final 2: Proportions 3 Level Service
This visualization reveals that Rehab/Residential services by far are the most effective in improving the frequency of substance use, with 49.2% of patients showing improvement compared to 27.5% in Detox and 18.3% in Ambulatory services. Rehab/Residential programs provide a structured and immersive environment that allows patients to focus entirely on recovery, offering comprehensive support for behavioral stabilization and transformation. Detox services are moderately effective, as they address acute withdrawal symptoms but may lack the long-term support needed for sustained improvement. Ambulatory services show the least progress, likely due to their outpatient nature, which may not provide the intensity or continuity of care required for significant behavioral changes. All this highlights the importance of treatment settings that combine medical and psychological interventions to support long-term recovery.
```{r}
# Compute proportions
plot_data <- service_mosaic %>%
  count(lengthOfStay, EMPLOYMENT_CHANGE) %>%
  group_by(lengthOfStay) %>%
  mutate(proportion = n / sum(n)) %>%
  mutate(EMPLOYMENT_CHANGE = factor(EMPLOYMENT_CHANGE, levels = c("Worse", "Same", "Improved")))

# Create the plot
ggplot(plot_data, aes(x = lengthOfStay, y = proportion, fill = EMPLOYMENT_CHANGE)) +
  geom_bar(stat = "identity", position = "fill") +
  geom_text(aes(label = scales::percent(proportion, accuracy = 0.1)), 
            position = position_fill(vjust = 0.5), size = 5, fontface = "bold") +
  labs(title = "Impact of Treatment Service on Frequency of Use", 
       subtitle = "Among Substance Use Patients in Public Facilities (2021)",
       x = "Treatment Service",
       y = "Percentage of Patients",
       fill = "Frequency of Use Change") +
  scale_fill_manual(values = c("Improved" = "darkgreen", "Same" = "gray", "Worse" = "red")) +
  theme_classic() +
  theme(legend.position = "bottom",
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
        plot.subtitle = element_text(face = "italic", hjust = 0.5, size = 11),
        axis.title.x = element_text(size = 14, face = "bold"), 
        axis.text.x = element_text(size = 12, face = "bold"))


```
## State Map Avg Usage Worse to Improve
This US map visualizes average frequency of use changes by state, with values ranging from -1 (worse) to 1 (improved). While the initial goal was to identify trends related to political affiliations of states (e.g., swing, blue, or red states), the results show no discernible connection between state political alignment and frequency of use outcomes from substance use treatment. As well as little connection of any hotspots or culster of states with good or bad health. Importantly, all states except Arizona, North Carolina, and Washington exhibited a positive average change score, indicating overall improvements in frequency of use. This suggests that frequency of use outcomes after treatment are more likely influenced by state-level treatment policies, funding, or demographic factors rather than political alignment. This is not included in our presentaiton as state is not a treatment related factor and our research question is center around those. 
```{r}
los_map <- los_mosaic %>%
  rename(state = STFIPS) %>% 
  mutate(EMPLOYMENT_CHANGE_counter = case_when(
         EMPLOYMENT_CHANGE == "Same" ~ 0,   
         EMPLOYMENT_CHANGE == "Worse" ~ -1, 
         EMPLOYMENT_CHANGE == "Improved" ~ 1, 
         TRUE ~ NA_real_)) %>%
  group_by(state) %>%                
  summarize(value = mean(EMPLOYMENT_CHANGE_counter, na.rm = TRUE)) %>% 
  mutate(state = tolower(state))    

us_map <- map_data("state")

map_data <- us_map %>%
  left_join(los_map, by = c("region" = "state"))


state_centers <- map_data %>%
  group_by(region) %>%
  summarize(long = mean(range(long, na.rm = TRUE)),
            lat = mean(range(lat, na.rm = TRUE)),
            value = mean(value, na.rm = TRUE)) %>%
  ungroup() 

ggplot(map_data, aes(x = long, y = lat, group = group, fill = value)) +
  geom_polygon(color = "black") + 
  scale_fill_gradient2(low = "red",    
                       mid = "white",     
                       high = "darkgreen",     
                       midpoint = 0,      
                       na.value = "gray90") +
  geom_text(data = state_centers,
            aes(x = long, y = lat, label = round(value, 2)), inherit.aes = FALSE, color = "black", size = 3) +
  labs(title = "Choropleth Map of Employment Changes by State",
       fill = "Average Change",
       caption = "Values range from -1 (Worse) to 1 (Improved)", # Add caption
       x = "",
       y = "") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank())




```

## Proportion All Levels of Services
This visualization provides a more detailed breakdown of ambulatory and residential treatment services to investigate whether specific subcategories reveal unique trends in frequency of use outcomes. However, the results show no significant differences within the subcategories, as the proportions of "Improved," "Same," and "Worse" outcomes are consistent with the broader service categories. Therefore, it is reasonable and efficient to generalize findings at the higher level (Ambulatory, Detox, Rehab/Residential) without delving into these specific subcategories, as they do not provide additional actionable insights.
```{r}
los_mosaic %>%
  filter(FREQ1 != "1") %>%
  count(SERVICES, EMPLOYMENT_CHANGE) %>%
  group_by(SERVICES) %>%
  mutate(proportion = n / sum(n)) %>%
  mutate(EMPLOYMENT_CHANGE = factor(EMPLOYMENT_CHANGE, levels = c("Worse", "Same", "Improved"))) %>%
  ggplot(aes(x = SERVICES, y = proportion, fill = EMPLOYMENT_CHANGE)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(title = "Proportion of Frequency of Use Outcomes by Service Type",
       x = "Service Type",
       y = "Proportion",
    fill = "Frequency of Use Outcome") +
  scale_fill_manual(values = c("Improved" = "darkgreen", "Same" = "#D3D3D3", "Worse" = "red")) +
  theme_minimal() +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Mosaic All Levels of Service
The visualization highlights differences in how Length of Stay and service types interact in affecting employment outcomes. Specifically, for Ambulatory services, longer stays >90 days show more substantial improvements in employment status compared to shorter stays <30 days, where improvements are minimal. For Detox, most observations are concentrated in stays under 30 days, suggesting that LOS has limited impact due to the nature of the service focusing on short-term withdrawal management. On the Rehab/Residential side, there is little variation in employment outcomes across LOS categories, indicating that the comprehensive nature of residential programs provides consistent support regardless of duration. All this being I see reason to present this in my final presentation as there is not much being added and the additional complexity is not needed.
```{r}
combined_mosaic <- los_mosaic %>%
  mutate(SERVICES3 = case_when(
      SERVICES %in% c("Detox, 24-hour, hospital inpatient",
                      "Detox, 24-hour, free-standing residential",
                      "Ambulatory, detoxification") ~ "Detox",
      SERVICES %in% c("Rehab/residential, hospital (non-detox)",
                      "Rehab/residential, short term (30 days or fewer)",
                      "Rehab/residential, long term (more than 30 days)") ~ "Rehab/Residential",
      SERVICES %in% c("Ambulatory, intensive outpatient",
                      "Ambulatory, non-intensive outpatient") ~ "Ambulatory")) %>%
  mutate(SERVcommaLOS = paste(SERVICES3, lengthOfStay,sep = ", ")) %>% 
  mutate(SERVcommaLOS = factor(SERVcommaLOS,
      levels =c("Ambulatory, < 30 days",
                "Ambulatory, 30-90 days",
                "Ambulatory, > 90 days",
                "Detox, < 30 days",
                "Detox, 30-90 days",
                "Detox, > 90 days",
                "Rehab/Residential, < 30 days",
                "Rehab/Residential, 30-90 days",
                "Rehab/Residential, > 90 days")))

combined_mosaic %>%
  ggplot() +
  geom_mosaic(aes(x = product(EMPLOYMENT_CHANGE, SERVcommaLOS), fill = EMPLOYMENT_CHANGE)) +
  geom_mosaic_text(aes(x = product(EMPLOYMENT_CHANGE, SERVcommaLOS), label = paste0(round(after_stat(.wt) / sum(after_stat(.wt)) * 100, 1), "%"))) +
  labs(fill = "Usage Change",
       y = "Proportion of Substance Use Patients",
       x = "Service, Length of Stay",
       title = "Impact of Length of Stay on Frequency of Use Change",
       subtitle = "Among Substance Use Patients in Public Facilities (2021)") +
  scale_fill_manual(values = c("Improved" = "darkgreen", "Same" = "#D3D3D3", "Worse" = "red"))+
    theme_classic() +
  coord_flip() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
        plot.subtitle = element_text(face = "italic", hjust = 0.5, size = 11))
```
## Final: EMPLOY_D Distribution
This plot displays the distribution of patients across three employment categories: "Unemployed," "Not in labor force," and "Employed." The largest group is "Unemployed," followed by "Not in labor force" and "Employed," which suggests that a significant portion of patients entering treatment may face employment challenges. Note it is the only distribution where the "negative" outcome is the biggest category.
```{r}
data1 %>%
  filter(EMPLOY_D != -9) %>%
  mutate(EMPLOY_D = ifelse(EMPLOY_D %in% c("Part-time", "Full-time"), "Employed", EMPLOY_D)) %>%
  mutate(EMPLOY_D = case_when(EMPLOY_D == 5 ~ "Unemployed", EMPLOY_D == 6 ~ "Not in labor force", TRUE ~ as.character(EMPLOY_D))) %>%
  group_by(EMPLOY_D) %>%
  count() %>%
  ggplot(aes(x = EMPLOY_D, y = n, fill = EMPLOY_D)) +
  geom_bar(stat = "identity", color = "black") +
  geom_text(aes(label = EMPLOY_D), position = position_stack(vjust = 0.5), color = "black", size = 4) +
  coord_flip() +
  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale())) +
  labs(y = "# of Patients", x = "") + 
  theme_minimal() +
  theme(axis.text.x = element_text(size = 10, color = "black"), 
        axis.text.y = element_blank(), 
        axis.ticks.x = element_line(color = "black"), 
        axis.line.x = element_line(color = "black"), 
        panel.grid = element_blank(),
        legend.position = "none")


```
 
## Final: FREQ1_D Distribution
This plot displays the distribution of patients across three substance use frequency categories: "Daily use," "Some use," and "No use in the past month." The largest group is "No use in the past month," followed by "Some use" and "Daily use," indicating that a significant portion of patients exit treatment report no or infrequent use.
```{r}
data1 %>%
  group_by(FREQ1_D) %>%
  count() %>%
  ggplot(aes(x = FREQ1_D, y = n, fill = FREQ1_D)) +
  geom_bar(stat = "identity", color = "black") +
  geom_text(aes(label = FREQ1_D), position = position_stack(vjust = 0.5), color = "black", size = 4) +
  coord_flip() +
  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale())) +
  labs(y = "# of Patients", x = "") + 
  theme_minimal() +
  theme(axis.text.x = element_text(size = 10, color = "black"), 
        axis.text.y = element_blank(), 
        axis.ticks.x = element_line(color = "black"), 
        axis.line.x = element_line(color = "black"), 
        panel.grid = element_blank(),
        legend.position = "none")

```
## Final LIVARAG_D Distribution
This plot displays the distribution of patients across three living situations: "Independent living," "Dependent living," and "Homeless." The largest group is "Independent living," followed by "Dependent living" and "Homeless," indicating that most patients exit treatment having stable housing, though a significant portion still faces housing insecurity.
```{r}
data1 %>%
  filter(LIVARAG_D != -9) %>%
  group_by(LIVARAG_D) %>%
  count() %>%
  ggplot(aes(x = LIVARAG_D, y = n, fill = LIVARAG_D)) +
  geom_bar(stat = "identity", color = "black") +
  geom_text(aes(label = LIVARAG_D), position = position_stack(vjust = 0.5), color = "black", size = 4) +
  coord_flip() +
  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale())) +
  labs(y = "# of Patients", x = "") + 
  theme_minimal() +
  theme(axis.text.x = element_text(size = 10, color = "black"), 
        axis.text.y = element_blank(), 
        axis.ticks.x = element_line(color = "black"), 
        axis.line.x = element_line(color = "black"), 
        panel.grid = element_blank(),
        legend.position = "none")
```

# Conclusion and Next Steps
Please refer to the video presentation for further interpretation of the meaning behind the results. Overall, we see that there is real indication of length of stay and service type and that treatment programs should consider tailoring LOS and service based on the specific goals of the patient in terms of how they are trying to reduce their usage. It would be interesting to further look into how this works for people admitted with varying levels of usage—does someone who comes in with high usage need a different treatment plan from someone with only moderate usage? I think this is where I will go for my capstone talk; I think it could be insightful.
